generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  phoneNumber   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  bankAccounts  BankAccount[]
  transactions  Transaction[]
  budgets       Budget[]
  investments   Investment[]
  portfolioTransactions PortfolioTransaction[]
  aiRecommendations AIRecommendation[]
  investmentPreferences InvestmentPreference[]
  cryptoHoldings CryptoHolding[]
  chatHistory   ChatMessage[]
  alerts        Alert[]
  notifications Notification[]
  bills         Bill[]
  receipts      Receipt[]
  financialHealthScores FinancialHealthScore[]
  userCohorts   UserCohort[]
  cashFlowPredictions CashFlowPrediction[]
  taxDeductions TaxDeduction[]
  wealthMilestones WealthMilestone[]
  smartBudgets  SmartBudget[]
  tellerEnrollments TellerEnrollment[]
  
  // Premium Features
  tradingOrders TradingOrder[]
  weeklyReports WeeklyReport[]
  debtAccounts  DebtAccount[]
  debtPayoffPlan DebtPayoffPlan?
  portfolioTargets PortfolioTarget[]
  rebalancingHistory RebalancingHistory[]
  creditScores  CreditScore[]
  retirementPlan RetirementPlan?
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // budget_alert, unusual_transaction, bill_reminder, investment_alert, savings_milestone
  title       String
  message     String
  severity    String   @default("info") // info, warning, critical
  actionUrl   String?
  isRead      Boolean  @default(false)
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, isRead])
}

model Bill {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  category        String
  amount          Float
  dueDate         DateTime
  frequency       String   // monthly, weekly, yearly, one-time
  autopayEnabled  Boolean  @default(false)
  paymentMethod   String?
  isActive        Boolean  @default(true)
  lastPaidDate    DateTime?
  nextDueDate     DateTime?
  notes           String?
  createdAt       DateTime @default(now())

  @@index([userId])
}

model Receipt {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionId   String?
  transaction     Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  imageUrl        String
  merchantName    String?
  amount          Float?
  date            DateTime?
  category        String?
  items           Json?
  ocrText         String?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([transactionId])
}

model FinancialHealthScore {
  id                      String   @id @default(uuid())
  userId                  String
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  overallScore            Int
  emergencyFundScore      Int?
  debtManagementScore     Int?
  savingsRateScore        Int?
  investmentDiversityScore Int?
  budgetAdherenceScore    Int?
  components              Json?
  recommendations         Json?
  calculatedAt            DateTime @default(now())

  @@index([userId, calculatedAt])
}

model UserCohort {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ageRange    String?
  incomeRange String?
  location    String?
  cohortHash  String
  createdAt   DateTime @default(now())
}

model CashFlowPrediction {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  predictionDate   DateTime
  predictedBalance Float
  incomeEvents     Json?
  expenseEvents    Json?
  confidenceScore  Float?
  createdAt        DateTime @default(now())

  @@index([userId, predictionDate])
}

model TaxDeduction {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  taxYear       Int
  category      String
  amount        Float
  description   String?
  date          DateTime
  isApproved    Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([userId, taxYear])
}

model WealthMilestone {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestoneType   String
  targetAmount    Float?
  currentAmount   Float?
  progressPercent Float?
  status          String   @default("in_progress")
  completedAt     DateTime?
  orderIndex      Int?
  createdAt       DateTime @default(now())

  @@index([userId, orderIndex])
}

model SmartBudget {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category         String
  allocatedAmount  Float
  spentAmount      Float    @default(0)
  rolloverAmount   Float    @default(0)
  autoAdjust       Boolean  @default(true)
  historicalAverage Float?
  month            DateTime
  createdAt        DateTime @default(now())

  @@unique([userId, category, month])
  @@index([userId, month])
}


model TellerEnrollment {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accessToken     String
  enrollmentId    String   @unique
  institutionName String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  bankAccounts    BankAccount[]
  
  @@index([userId])
}

model BankAccount {
  id                  String   @id @default(uuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  enrollmentId        String?
  enrollment          TellerEnrollment? @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)
  
  tellerAccountId     String   @unique
  
  institutionName     String
  accountName         String
  accountType         String
  accountNumber       String?
  routingNumber       String?
  
  available           Float    @default(0)
  current             Float    @default(0)
  limit               Float?
  currency            String   @default("USD")
  
  status              String   @default("active")
  lastSyncedAt        DateTime @default(now())
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  transactions        Transaction[]
  
  @@index([userId])
  @@index([tellerAccountId])
}

model Transaction {
  id                  String   @id @default(uuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bankAccountId       String
  bankAccount         BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  
  tellerTransactionId String   @unique
  amount              Float
  date                DateTime
  description         String
  merchantName        String?
  
  status              String
  type                String
  
  category            String?
  subcategory         String?
  isRecurring         Boolean  @default(false)
  isTaxDeductible     Boolean  @default(false)
  confidence          Float?
  
  details             Json?
  
  receipts            Receipt[]
  taxDeductions       TaxDeduction[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId, date])
  @@index([tellerTransactionId])
  @@index([category])
}

model Budget {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  category        String
  monthlyLimit    Float
  currentSpent    Float    @default(0)
  month           DateTime
  alertThreshold  Float    @default(80)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, category, month])
  @@index([userId, month])
}

model Investment {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  symbol          String
  name            String
  type            String
  sector          String?
  quantity        Float
  purchasePrice   Float
  currentPrice    Float
  totalValue      Float
  gainLoss        Float
  gainLossPercent Float
  riskLevel       String?  @default("medium")
  investmentGoal  String?
  targetAllocation Float?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
}

model AIRecommendation {
  id                 String   @id @default(uuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendationType String
  symbol             String?
  reasoning          String   @db.Text
  confidenceScore    Float?
  targetPrice        Float?
  riskLevel          String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())

  @@index([userId, isActive])
}

model PortfolioTransaction {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol           String
  transactionType  String
  shares           Float
  price            Float
  totalAmount      Float
  transactionDate  DateTime @default(now())

  @@index([userId])
  @@index([symbol])
}

model Alert {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type            String
  title           String
  message         String
  severity        String
  isRead          Boolean  @default(false)
  metadata        Json?
  
  createdAt       DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
}

model ChatMessage {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role            String
  content         String   @db.Text
  audioUrl        String?
  avatarVideoUrl  String?
  
  createdAt       DateTime @default(now())
  
  @@index([userId, createdAt])
}

model InsiderTrading {
  id                 String   @id @default(uuid())
  symbol             String
  filingDate         DateTime
  transactionDate    DateTime?
  insiderName        String
  insiderTitle       String?
  transactionType    String
  shares             Float
  price              Float?
  value              Float?
  sharesOwnedAfter   Float?
  isSignificant      Boolean  @default(false)
  createdAt          DateTime @default(now())

  @@index([symbol])
  @@index([filingDate(sort: Desc)])
}

model StockPrediction {
  id                 String   @id @default(uuid())
  symbol             String
  predictionDate     DateTime
  predictedPrice     Float
  confidenceScore    Float?
  predictionHorizon  String?
  technicalIndicators Json?
  aiAnalysis         String?
  createdAt          DateTime @default(now())

  @@index([symbol])
}

model InvestmentPreference {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category         String
  riskTolerance    Float
  investmentAmount Float
  timeHorizon      String?
  goals            Json?
  updatedAt        DateTime @default(now())

  @@unique([userId, category])
  @@index([userId])
}

model CryptoHolding {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol           String
  amount           Float
  avgCost          Float
  currentPrice     Float?
  marketValue      Float?
  totalGainLoss    Float?
  gainLossPercent  Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())

  @@index([userId])
}

// ============ PREMIUM FEATURES ============

model TradingOrder {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol          String
  orderType       String   // market, limit, stop_loss
  side            String   // buy, sell
  quantity        Float
  price           Float?
  stopPrice       Float?
  status          String   @default("pending") // pending, filled, cancelled, rejected
  filledPrice     Float?
  filledQuantity  Float?
  alpacaOrderId   String?
  createdAt       DateTime @default(now())
  filledAt        DateTime?

  @@index([userId, createdAt(sort: Desc)])
}

model WeeklyReport {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weekStart      DateTime
  weekEnd        DateTime
  netWorth       Float
  netWorthChange Float
  highlights     Json
  warnings       Json
  opportunities  Json
  nextWeekGoals  Json
  reportText     String?  @db.Text
  createdAt      DateTime @default(now())

  @@unique([userId, weekStart])
  @@index([userId, weekStart(sort: Desc)])
}

model DebtAccount {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditorName   String
  accountType    String   // credit_card, personal_loan, auto_loan, student_loan, mortgage
  balance        Float
  interestRate   Float
  minimumPayment Float
  currentPayment Float?
  dueDate        Int?     // day of month
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  @@index([userId])
}

model DebtPayoffPlan {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy       String   // avalanche, snowball
  totalDebt      Float
  monthlyPayment Float
  payoffMonths   Int?
  totalInterest  Float?
  debtOrder      Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model PortfolioTarget {
  id                  String   @id @default(uuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetType           String
  targetPercent       Float
  currentPercent      Float?
  rebalanceThreshold  Float    @default(5.0)
  createdAt           DateTime @default(now())

  @@unique([userId, assetType])
}

model RebalancingHistory {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rebalancedAt DateTime @default(now())
  trades       Json
  taxImpact    Float?
  notes        String?  @db.Text
}

model CreditScore {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  score           Int
  provider        String?  // experian, equifax, transunion, simulated
  factors         Json?
  recommendations Json?
  recordedAt      DateTime @default(now())

  @@index([userId, recordedAt(sort: Desc)])
}

model RetirementPlan {
  id                   String   @id @default(uuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentAge           Int
  retirementAge        Int
  currentSavings       Float
  monthlyContribution  Float
  expectedReturn       Float    @default(7.0)
  inflationRate        Float    @default(3.0)
  projectedValue       Float?
  monthlyIncome        Float?
  isOnTrack            Boolean?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}
